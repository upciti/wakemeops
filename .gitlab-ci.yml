workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

stages:
  - publish

build_images:
  image: quay.io/buildah/stable:v1.23.1
  stage: publish
  tags: ["docker"]
  needs: []
  variables:
    REGISTRY_USER: "wakemeops"
  parallel:
    matrix:
      - IMAGE: ubuntu
        TAG:
          - "latest"
          - "rolling"
          - "22.04"
          - "20.04"
          - "18.04"
        REGISTRY_NAME: ubuntu
      - IMAGE: debian
        TAG:
          - "latest"
          - "bookworm"
          - "bookworm-slim"
          - "bullseye"
          - "bullseye-slim"
          - "buster"
          - "buster-slim"
        REGISTRY_NAME: debian
      - IMAGE: bitnami/minideb
        TAG: ["latest", "bullseye", "buster"]
        REGISTRY_NAME: minideb
  retry: 1
  before_script:
    - IMAGE_NAME="${REGISTRY_USER}/${REGISTRY_NAME}:${TAG}"
    - buildah login -u ${REGISTRY_USER} -p ${REGISTRY_TOKEN} docker.io
  script:
    - >
      buildah bud \
        -f ./Dockerfile \
        -t ${IMAGE_NAME} \
        --build-arg IMAGE=${IMAGE} \
        --build-arg TAG=${TAG} \
        --label org.wakemeops.maintainers="WakeMeOps <wakemeops.com>" \
        --label org.wakemeops.base_image="docker.io/${IMAGE}:${TAG}" \
        --label org.wakemeops.commit="${CI_COMMIT_SHA}" \
        .
    - buildah push --authfile /run/containers/0/auth.json ${IMAGE_NAME}
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
      changes:
        - Dockerfile
        - .gitlab-ci.yml
        - assets/**/*
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $BUILD_IMAGES == "1"'
