name: ðŸš€ Update blueprints

on:
  push:

jobs:
  bump_blueprints:
    runs-on: ubuntu-latest
    container:
      image: upciti/wakemebot:main
      options: --user 1001
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Bump blueprints
        run: |
          #make update
          touch test
          echo -e "Updated aaa from 1.0.0 to 2.0.0\n" > ops2deb-devops.log

      - name: Build commit content
        id: get-commit-content
        run: |
          changes="$(cat ops2deb-*.log)"
          if [[ $(echo "$changes" | wc -l) -gt 1 ]]; then
            title="chore(bot): update blueprints"
            body="$changes"
          else
            title="chore(bot): $(echo "$changes" | tr '[:upper:]' '[:lower:]')"
            body=
          fi
          echo ::set-output name=title::$title
          echo ::set-output name=body::"${body//$'\n'/'%0A'}"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.WAKEMEBOT_GITHUB_ACCESS_TOKEN }}
          commit-message: |
            ${{ steps.get-commit-content.outputs.title }}
            ${{ steps.get-commit-content.outputs.body }}
          committer: wakemebot <wakemebot@protonmail.com>
          author: wakemebot <wakemebot@users.noreply.github.com>
          branch: chore/update-blueprints
          delete-branch: true
          title: ${{ steps.get-commit-content.outputs.title }}
          body: ${{ steps.get-commit-content.outputs.body }}

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v1
        with:
          token: ${{ secrets.WAKEMEBOT_GITHUB_ACCESS_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: rebase
